language: c

env:
  global:
    - CACHE=$HOME/.sdlpal-caches

cache:
  directories:
    - $CACHE

before_script:
  - mkdir deploy

matrix:
    fast_finish: true
    include:
      - os: linux
        env: TARGET=3ds EXT=cia
        addons:
          apt:
            packages:
            - unzip
        services:
          - docker
        before_install:
          - export PUSHD="$(pwd)"
          - mkdir -p $CACHE/
          - cd $CACHE/
          - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
          - docker run -dit --name devkit -v $(pwd):/cache -v $TRAVIS_BUILD_DIR:/src devkitpro/devkitarm bash
          - |
            if ! [ -d $CACHE/SDL-1.2-N3DS ]
            then
              git clone https://github.com/zephray/SDL-1.2-N3DS.git
              sed -i 's/GSPGPU_FramebufferFormats/GSPGPU_FramebufferFormat/g' SDL-1.2-N3DS/SDL-1.2.15/src/video/n3ds/SDL_n3dsvideo.h
            fi
          - docker exec -it devkit make -C cache/SDL-1.2-N3DS/SDL-1.2.15 -f Makefile.n3ds install
          - |
            if ! [ -f $CACHE/Linux_x86_64/ctrtool ] || ! [ -f $CACHE/Linux_x86_64/makerom ]
            then
              wget https://github.com/profi200/Project_CTR/releases/download/0.15/makerom_015_ctrtool.zip
              unzip -o makerom_015_ctrtool.zip
              chmod +x Linux_x86_64/*
            fi
          - docker exec -it devkit cp /cache/Linux_x86_64/{ctrtool,makerom} /opt/devkitpro/tools/bin
          - cd "${PUSHD}"
        script:
          - cd 3ds
          - docker exec -it devkit make -C src/3ds cia
          - cp sdlpal.cia ../deploy/sdlpal-3ds.cia
          - cd ..

before_deploy:
  - sed=sed; date=date
  - |
    if [[ "$TRAVIS_OS_NAME" == "osx" ]]
    then
        brew update
        brew install gnu-sed
        sed=gsed
        date=gdate
    fi
  - DATE=$($date -d $(git show -s --format=%cI) "+%F")
  - COMMIT=$(git rev-parse --short HEAD)
  - set -f
  - |
    $sed -i "
    s/@VERSION@/v$DATE-g$COMMIT/g
    s/@DESC@/$(echo -n $TRAVIS_COMMIT_MESSAGE|tr '\r' '\\r'|tr '\n' '\\n'|sed -e 's@[\\"]@\\&@g;s@[/&\$]@\\&@g')/g
    s/@RELEASE_DATE@/$(git show -s --format=%cI)/g
    s/@VCS_TAG@/$(git describe --tags)/g
    s/@AUTHOR@/$(git show -s --format=%an)/g
    s/@AUTHOR_DATE@/$(git show -s --format=%ai)/g
    s/@CIMMITER@/$(git show -s --format=%cn)/g
    s/@BRANCH@/$TRAVIS_BRANCH/g
    s/@COMMITID@/$(git show -s --format=%h)/g
    " bintray.json
  - set +f

deploy:
  - provider: releases
    api_key:
      secure: FFV8UBcz6GkeSoGRbrL9tnTpVqXoFjFK2QtW0Ml8YvvqaHhxOaIWs2nAabOGsW1mJop/QlpuUNw1TfLl7TokcUDgOHrFRdC8hVY7K1uSWMnt7m4ZRPatVybIkzgrnItHlnMrL4uJK2xXb6Jc5+cSrU5jRMcmTZjaOKLTBwF97+6AgqpdmKUCVYZJzQYg0Jn9GfaL1EOGl7ISt/VEgi/tKFzJvJVxJBU3NuKyxXlfEwkTiSOFuGoD5qWDjCE+aGxTR6RQefsADPIDfeU3TJHTJE/ORGy9gl+Y41JgU0Bfgipcqg1RSwNclclmxgi8lo/XNUiZAMTyQrXjByBWcvYovk+H4h9mbvJlrVSjI8Wxb5ICcYkhDVkNxtEXX7AsIk4yHiNTi1MAW0qJJKinaFxLmK2U3LGEK3DudXl/0eVRoQATmRcXLdBQezISt2CWpTktCxlQmtz/GsoHv0PcWdkJYL4qbbRrBRFj9++VjlnCI124YZnbVjC3+jtWN1Zluxynj0GDBY3r7EdLWWKZo5XnygPOZ8+uaTMYfqmTvQWPc5GRRRdVJowQFQhb48hzKyWYqsf8eyS3VuZ9b/DwES3dutOaX7sIL9Vkg3DlQYOEz938MB4VbTGizUUrBbrIP4Kz/+WOZ9pxM9X+qsgMYkw8FvHqn2TvCWxPDCgqq3zUWig=
    file_glob: true
    file: deploy/*
    skip_cleanup: true
    overwrite: true
    on:
      all_branches: true
      tags: true
  - provider: bintray
    user: $BINTRAY_USER
    key: $BINTRAY_KEY
    file: bintray.json
    skip_cleanup: true
    on:
      all_branches: true

notifications:
  webhooks:
    urls:
      - https://webhooks.gitter.im/e/922838d6727e919df50e
    on_success: always  # options: [always|never|change] default: always
    on_failure: always  # options: [always|never|change] default: always
    on_start: never     # options: [always|never|change] default: always
